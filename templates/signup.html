<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signup | EduCaption</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<main class="container">
  <div class="form-card">
    <h2>Create Account</h2>
    <form onsubmit="event.preventDefault(); createAccount();">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Sign Up</button>
    </form>

    <div class="divider">OR</div>

    <button onclick="googleSignup()" class="google-btn">
      <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Icon" class="google-icon">
      Sign up with Google
    </button>

    <p>Already have an account? <a href="{{ url_for('login') }}">Login</a></p>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "{{ FIREBASE_API_KEY }}",
    authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
    messagingSenderId: "{{ FIREBASE_MSG_SENDER_ID }}",
    appId: "{{ FIREBASE_APP_ID }}",
    measurementId: "{{ FIREBASE_MEASUREMENT_ID }}"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  
  // Configure Google provider to reduce popup blocking
  provider.setCustomParameters({
    prompt: 'select_account'
  });

  // Helper function to make requests with proper CORS headers
  async function makeAuthenticatedRequest(url, data) {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest"
      },
      credentials: "include",
      body: JSON.stringify(data)
    });
    
    return response;
  }

  window.createAccount = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
      alert("Please enter both email and password");
      return;
    }
    
    if (password.length < 6) {
      alert("Password must be at least 6 characters long");
      return;
    }
    
    try {
      console.log("Attempting account creation...");
      const userCred = await createUserWithEmailAndPassword(auth, email, password);
      console.log("Account created successfully, getting token...");
      
      const token = await userCred.user.getIdToken();
      localStorage.setItem("firebase_id_token", token);
      
      console.log("Sending token to backend...");
      const res = await makeAuthenticatedRequest("/callback", { idToken: token });
      
      const data = await res.json();
      console.log("Backend response:", data);
      
      if (res.ok && data.status === "success") {
        console.log("Signup successful, redirecting...");
        window.location.href = "/index";
      } else {
        alert("Signup failed: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      console.error("Signup error:", err);
      alert("Error: " + err.message);
    }
  };

  window.googleSignup = async () => {
    try {
      console.log("Attempting Google signup...");
      const result = await signInWithPopup(auth, provider);
      console.log("Google signup successful, getting token...");
      
      const token = await result.user.getIdToken();
      localStorage.setItem("firebase_id_token", token);
      
      console.log("Sending token to backend...");
      const res = await makeAuthenticatedRequest("/callback", { idToken: token });
      
      const data = await res.json();
      console.log("Backend response:", data);
      
      if (res.ok && data.status === "success") {
        console.log("Google signup successful, redirecting...");
        window.location.href = "/index";
      } else {
        alert("Google signup failed: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      console.error("Google Signup error:", err);
      
      // Handle specific popup blocked errors
      if (err.code === 'auth/popup-blocked') {
        alert("Popup was blocked. Please allow popups for this site and try again.");
      } else if (err.code === 'auth/popup-closed-by-user') {
        console.log("User closed the popup");
      } else {
        alert("Google Signup Error: " + err.message);
      }
    }
  };
</script>
</body>
</html>